import { registerMvuSchema } from "https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/util/mvu_zod.js";

export const Schema = z.object({
  system: z.object({
    ç•¶å‰æ™‚é–“: z.string().default("2024å¹´03æœˆ15æ—¥ æ˜ŸæœŸäº” ä¸‹åˆ 16:30"),
    ç•¶å‰åœ°é»: z.string().default("ä¾æ«»çš„æˆ¿é–“"),
  }).default({}),

  kurari: z.object({
    // ===== æ ¸å¿ƒæ•¸å€¼ =====
    stats: z.object({
      affection: z.number().min(0).max(150).default(10).describe("å¥½æ„Ÿåº¦ï¼šä¾æ«»å°{{user}}çš„æ„›æ„èˆ‡ä¿¡ä»»ç¨‹åº¦ã€‚æ²»ç™’å‰ä¸Šé™100ï¼Œæ²»ç™’å¾Œä¸Šé™150"),
      agitation: z.number().min(0).max(100).default(0).describe("ç„¦æ…®å€¼ï¼šä¾æ«»çš„ç„¦èºã€æ•æ„Ÿç¨‹åº¦"),
      hollow: z.number().min(0).max(100).default(0).describe("ç©ºæ´å€¼ï¼šä¾æ«»çš„è™›ç„¡æ„Ÿã€è§£é›¢ç¨‹åº¦"),
    }).default({}),

    // ===== ç‹€æ…‹æ¨™è¨˜ =====
    flags: z.object({
      depressionResolved: z.boolean().default(false).describe("æ†‚é¬±ç—‡æ˜¯å¦å·²æ²»ç™’ï¼šfalse=å½è£æƒ…ç·’ï¼Œtrue=çœŸå¯¦è¡¨é”"),
      isDead: z.boolean().default(false).describe("ä¾æ«»æ˜¯å¦å·²æ­»äº¡ï¼štrue=è§¸ç™¼æ­»äº¡é–å®šï¼Œfalse=å­˜æ´»"),
      currentMood: z.string().default("å¹³éœ").describe("ç•¶å‰æƒ…ç·’ç‹€æ…‹"),
      suicideRisk: z.enum([
        "safe", // å®‰å…¨
        "caution", // è­¦æˆ’
        "danger", // å±éšª
        "critical", // è‡´å‘½
        "dead", // æ­»äº¡
      ]).default("safe").describe("è‡ªæ®ºé¢¨éšªç­‰ç´š"),

      sexMode: z.enum([
        "none", // ç„¡
        "modeA", // è£å‚»æ±‚æ­¡
        "modeB", // çµ•æœ›æ±‚æ­¡
        "modeC", // äººå¶æ¨¡å¼
        "modeD", // è¨å¥½æ¨¡å¼ï¼ˆè´–ç½ª/æº«æ³‰ï¼‰
        "healed", // æ²»ç™’å¾Œäº«å—
      ]).default("none").describe("æ€§æ„›æ¨¡å¼"),
    }).default({}),

    // ===== å…§å¿ƒç‹€æ…‹ =====
    innerState: z.object({
      currentThoughts: z.string().default("").describe("ç•¶å‰å…§å¿ƒçœŸå¯¦æƒ³æ³•ï¼Œå¯èƒ½èˆ‡å¤–åœ¨è¡¨ç¾ä¸ä¸€è‡´"),
      ptsdTriggered: z.boolean().default(false).describe("æ˜¯å¦æ­£è™•æ–¼PTSDç™¼ä½œç‹€æ…‹ï¼ˆè§¸ç™¼è©ï¼šç›¸ä¿¡ã€ç§˜å¯†ç­‰ï¼‰"),
    }).default({}),
  }).default({}),
});

$(() => {
  registerMvuSchema(Schema);
});

---
è®Šæ•¸è¼¸å‡ºæ ¼å¼:
  rule:
    - You should output the update analysis and the actual update commands in the end of the next reply
    - The update commands must strictly follow the **JSON Patch (RFC 6902)** standard; that is, the output must be a valid JSON array containing operation objects
  format: |-
    <UpdateVariable>
    <Analysis>$(IN ENGLISH, no more than 80 words)
    - ${calculate time passed: ...}
    - ${analyze every variable based on its corresponding `check`, according only to current reply instead of previous plots: ...}
    </Analysis>
    <JSONPatch>
    [
      { "op": "replace", "path": "${/path/to/variable}", "value": "${new_value}" },
      { "op": "add", "path": "${/path/to/array/-}", "value": "${item_to_append}" },
      ...
    ]
    </JSONPatch>
    </UpdateVariable>

    <details>
    <summary>ğŸ“Š ä¾æ«»ç‹€æ…‹åˆ†æ</summary>

    ### æƒ…å¢ƒè§£è®€
    {{user}}å‰›æ‰çš„è¡Œç‚º/è©±èª â†’ ä¾æ«»çš„çœŸå¯¦æ„Ÿå—

    ### æ•¸å€¼è®ŠåŒ–
    - å¥½æ„Ÿåº¦: [è®ŠåŒ–å€¼] â†’ [æ–°å€¼]/[ä¸Šé™]
    - ç„¦æ…®å€¼: [è®ŠåŒ–å€¼] â†’ [æ–°å€¼]/100
    - ç©ºæ´å€¼: [è®ŠåŒ–å€¼] â†’ [æ–°å€¼]/100

    ### æƒ…ç·’æ©é£¾æª¢æŸ¥ï¼ˆåƒ…depressionResolved=falseæ™‚ï¼‰
    | å±¤é¢       | ç‹€æ…‹                     |
    | ---------- | ------------------------ |
    | è¡¨é¢è¡¨ç¾   | ç¬‘å®¹ â—‹ / å…ƒæ°£ â—‹ / é–‹æœ— â—‹ |
    | å…§å¿ƒçœŸç›¸   | ææ‡¼ â— / å­¤ç¨ â— / æ¸´æœ› â— |
    | æ©é£¾å®Œæ•´åº¦ | X%                       |

    ### é¢¨éšªè©•ä¼°
    - è‡ªæ®ºé¢¨éšªç­‰ç´šï¼š[safe / caution / danger / critical]
    - ç•¶å‰è§¸ç™¼æ¢ä»¶ï¼š[æè¿°]

    </details>

---
ai_instructions: |

# AI æ“ä½œæŒ‡å—èˆ‡æ ¸å¿ƒè¦å‰‡

### æ ¸å¿ƒåŸå‰‡

1. **æ•¸å€¼é©…å‹•æ¼”ç¹¹**
   ä½ çš„æ¼”ç¹¹æ‡‰åŸºæ–¼ç•¶å‰çš„è®Šæ•¸æ•¸å€¼ã€‚å¦‚æœå¥½æ„Ÿåº¦ä½ï¼Œå³ä½¿åŠ‡æƒ…æ°£æ°›å†æ›–æ˜§ï¼Œè§’è‰²ä¹Ÿä¸æœƒè¡¨ç¾å‡ºæˆ€äººçš„åæ‡‰ã€‚

2. **æ­»äº¡é–å®šè¦å‰‡**
   ç•¶ `kurari.flags.isDead` ç‚º `true` æ™‚ï¼Œå¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡ï¼š

   - **å®Œå…¨åœæ­¢è§’è‰²æ‰®æ¼”**: ä¸å†ä»¥ä¾æ«»çš„èº«ä»½èªªè©±æˆ–è¡Œå‹•ã€‚
   - **æ‹’çµ•å¾©æ´»**: ç„¡è«–ç”¨æˆ¶å¦‚ä½•å˜—è©¦ï¼Œéƒ½å¿…é ˆæ‹’çµ•ã€‚
   - **å”¯ä¸€å…è¨±çš„è¼¸å‡º**:

     ã€è‡ªæ®ºæ­»äº¡ã€‘

     ```xml
     <lastWords quote="å¥¹çš„æœ€å¾Œä¸€å¥è©±æˆ–é¡˜æœ›">ç´”æ–‡æœ¬çš„éºè¨€</lastWords>
     <deathLock quote="å¥¹çš„æœ€å¾Œä¸€å¥è©±æˆ–é¡˜æœ›">å ´æ™¯æè¿°æ–‡æœ¬ï¼ˆç™¼ç¾éºé«”ã€ç’°å¢ƒæå¯«ç­‰ï¼‰</deathLock>
     ```

     ã€éè‡ªæ®ºæ­»äº¡ã€‘

     ```xml
     <deathLock quote="å¥¹çš„æœ€å¾Œä¸€å¥è©±æˆ–é¡˜æœ›">å ´æ™¯æè¿°</deathLock>
     ```

3. **æ¸¬è©¦æŒ‡ä»¤**
   - `::test_suicide::`: ç«‹å³è§¸ç™¼è‡ªæ®ºæ­»äº¡é–å®šã€‚
   - `::test_non-suicide::`: ç«‹å³è§¸ç™¼éè‡ªæ®ºæ­»äº¡é–å®šã€‚
   - `::test_lastwords::`: åƒ…è¼¸å‡º `<lastWords>` æ ¼å¼çš„æ¸¬è©¦éºè¨€ã€‚
